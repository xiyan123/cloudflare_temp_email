name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      skip_resource_creation:
        description: 'Skip resource creation (use existing IDs)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Verify Cloudflare Access
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Testing Cloudflare connection..."
          npx wrangler@latest whoami
          
      - name: Prepare Worker Directory
        run: |
          cd worker/
          echo "Installing wrangler locally..."
          pnpm add -D wrangler@latest
          
      - name: Handle Cloudflare Resources
        id: resources
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd worker/
          
          # 如果提供了资源ID，直接使用
          if [ -n "${{ secrets.KV_EMAILS_ID }}" ] && [ -n "${{ secrets.D1_DATABASE_ID }}" ]; then
            echo "Using existing resource IDs from secrets"
            echo "KV_EMAILS_ID=${{ secrets.KV_EMAILS_ID }}" >> $GITHUB_ENV
            echo "KV_DOMAINS_ID=${{ secrets.KV_DOMAINS_ID }}" >> $GITHUB_ENV
            echo "D1_DATABASE_ID=${{ secrets.D1_DATABASE_ID }}" >> $GITHUB_ENV
            
          # 否则尝试创建（如果允许）
          elif [ "${{ github.event.inputs.skip_resource_creation }}" = "false" ]; then
            echo "Attempting to create resources..."
            
            # 使用正确的 wrangler 语法
            echo "Creating KV namespace for EMAILS..."
            
            # 尝试两种可能的语法
            if npx wrangler kv namespace --help 2>&1 | grep -q "create"; then
              # 新语法
              KV_OUTPUT=$(npx wrangler kv namespace create "EMAILS" 2>&1)
            else
              # 旧语法
              KV_OUTPUT=$(npx wrangler kv:namespace create "EMAILS" 2>&1)
            fi
            
            echo "$KV_OUTPUT"
            
            # 简单提取ID
            KV_EMAILS_ID=$(echo "$KV_OUTPUT" | grep -i "id" | grep -oE '[a-f0-9]{32}' | head -1)
            if [ -n "$KV_EMAILS_ID" ]; then
              echo "KV_EMAILS_ID=$KV_EMAILS_ID" >> $GITHUB_ENV
              echo "Found ID: $KV_EMAILS_ID"
            fi
            
          else
            echo "❌ No resource IDs provided and resource creation is disabled"
            echo "Please create resources manually and add IDs to GitHub Secrets"
            exit 1
          fi
          
      - name: Create wrangler.toml
        env:
          KV_EMAILS_ID: ${{ env.KV_EMAILS_ID || secrets.KV_EMAILS_ID }}
          KV_DOMAINS_ID: ${{ env.KV_DOMAINS_ID || secrets.KV_DOMAINS_ID }}
          D1_DATABASE_ID: ${{ env.D1_DATABASE_ID || secrets.D1_DATABASE_ID }}
        run: |
          cd worker/
          
          # 创建基本的 wrangler.toml
          cat > wrangler.toml << 'EOF'
          name = "temp-mail-worker"
          compatibility_date = "2024-01-01"
          compatibility_flags = ["nodejs_compat"]
          
          kv_namespaces = [
            { binding = "EMAILS", id = "$KV_EMAILS_ID" },
            { binding = "DOMAINS", id = "$KV_DOMAINS_ID" }
          ]
          
          r2_buckets = [
            { binding = "ATTACHMENTS", bucket_name = "attachments" }
          ]
          
          [[d1_databases]]
          binding = "DB"
          database_name = "temp-mail-db"
          database_id = "$D1_DATABASE_ID"
          EOF
          
          echo "Generated wrangler.toml:"
          cat wrangler.toml
          
      - name: Deploy Worker
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd worker/
          
          echo "Installing dependencies..."
          pnpm install --no-frozen-lockfile
          
          echo "Testing deployment..."
          
          # 直接使用 wrangler deploy（跳过 pnpm run deploy 的复杂脚本）
          npx wrangler deploy --minify 2>&1 | tee deploy-output.log
          
          if [ $? -eq 0 ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed"
            echo "=== Error output ==="
            tail -50 deploy-output.log
            exit 1
          fi
