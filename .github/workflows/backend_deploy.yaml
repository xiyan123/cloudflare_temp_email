name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: Deploy Backend for ${{ github.ref_name }}
        run: |
          # 设置环境变量
          export use_worker_assets=${{ secrets.USE_WORKER_ASSETS }}
          export use_worker_assets_with_telegram=${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}
          export debug_mode=${{ secrets.DEBUG_MODE }}
          export use_mail_wasm_parser=${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}
          
          # 1. 构建前端资源（如果需要）
          if [ -n "$use_worker_assets" ]; then
            echo "=== 构建前端资源 ==="
            cd frontend/
            pnpm install --no-frozen-lockfile
            if [ -n "$use_worker_assets_with_telegram" ]; then
              echo "Building with telegram pages"
              pnpm build:telegram:pages
            else
              echo "Building with normal pages"
              pnpm build:pages
            fi
            cd ..
          fi
          
          # 2. 部署后端 Worker
          echo "=== 部署后端 Worker ==="
          cd worker/
          
          # 创建 wrangler.toml
          echo '${{ secrets.BACKEND_TOML }}' > wrangler.toml
          
          # 安装依赖
          echo "安装后端依赖..."
          pnpm install --no-frozen-lockfile
          
          # 3. 可选的邮件解析器安装
          if [ -n "$use_mail_wasm_parser" ]; then
            echo "Using mail-parser-wasm-worker"
            pnpm add mail-parser-wasm-worker
            
            # 应用补丁
            PATCH_FILE="../.github/config/mail-parser-wasm-worker.patch"
            if [ -f "$PATCH_FILE" ]; then
              echo "应用补丁..."
              # 使用 patch 命令，更可靠
              if command -v patch &> /dev/null || (sudo apt-get update && sudo apt-get install -y patch); then
                patch -p1 < "$PATCH_FILE" 2>/dev/null || echo "补丁应用可能失败，继续..."
              fi
            fi
          fi
          
          # 4. 执行部署 - 修复 wrangler 命令问题
          echo "=== 执行部署 ==="
          
          # 方法1：使用 npm 脚本（如果 package.json 中有 deploy 脚本）
          echo "检查 package.json 部署脚本..."
          if grep -q '"deploy"' package.json; then
            echo "使用 package.json 中的 deploy 脚本"
            pnpm run deploy
          else
            # 方法2：直接执行 wrangler
            echo "直接执行 wrangler..."
            
            # 确保 wrangler 可执行
            if [ -f "node_modules/.bin/wrangler" ]; then
              echo "使用本地安装的 wrangler"
              chmod +x node_modules/.bin/wrangler
              ./node_modules/.bin/wrangler deploy --minify
            else
              # 方法3：使用 npx
              echo "使用 npx 执行 wrangler"
              npx wrangler deploy --minify
            fi
          fi
          
          echo "Deployed for tag ${{ github.ref_name }}"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
