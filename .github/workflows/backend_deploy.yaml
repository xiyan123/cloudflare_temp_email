name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Build frontend
        run: |
          cd frontend/
          pnpm install --no-frozen-lockfile
          # æ ¹æ®é…ç½®é€‰æ‹©æ„å»ºç±»å‹
          if [ "${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}" = "true" ]; then
            pnpm build:telegram:pages
          else
            pnpm build:pages
          fi
          cd ..

      - name: Deploy Worker with nodejs_compat
        run: |
          cd worker/
          
          # åˆ›å»ºå®Œæ•´çš„ wrangler.toml é…ç½®
          cat > wrangler.toml << 'EOF'
name = "mail"
main = "src/worker.ts"
compatibility_date = "2025-12-08"
compatibility_flags = ["nodejs_compat"]

# è·¯ç”±é…ç½®
routes = [
  { pattern = "mail-t.tep-mail.org", custom_domain = true },
]

# èµ„äº§é…ç½®
[assets]
directory = "../frontend/dist/"
binding = "ASSETS"
run_worker_first = true

# é‚®ä»¶å‘é€é…ç½®
send_email = [
    { name = "SEND_MAIL" },
]

# ç¯å¢ƒå˜é‡
[vars]
PREFIX = ""
DOMAINS = ["tep-mail.org"]
JWT_SECRET = "${{ secrets.JWT_SECRET }}"
ENABLE_USER_CREATE_EMAIL = true
ENABLE_USER_DELETE_EMAIL = true

# æ•°æ®åº“é…ç½®
[[d1_databases]]
binding = "DB"
database_name = "tep-mail"
database_id = "b902bde1-607c-4f31-8619-97cae621e7d3"
EOF
          
          echo "=== wrangler.toml é…ç½® ==="
          cat wrangler.toml
          echo "========================="
          
          # å®‰è£…ä¾èµ–
          pnpm install --no-frozen-lockfile
          
          # å¯é€‰ï¼šå®‰è£…é‚®ä»¶è§£æå™¨
          if [ "${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}" = "true" ]; then
            echo "å®‰è£… mail-parser-wasm-worker..."
            pnpm add mail-parser-wasm-worker
            # åº”ç”¨è¡¥ä¸ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "../.github/config/mail-parser-wasm-worker.patch" ]; then
              echo "åº”ç”¨è¡¥ä¸..."
              patch -p1 < "../.github/config/mail-parser-wasm-worker.patch" 2>/dev/null || echo "è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œç»§ç»­..."
            fi
          fi
          
          # æ‰§è¡Œéƒ¨ç½²
          echo "å¼€å§‹éƒ¨ç½²åˆ° Cloudflare Workers..."
          npx wrangler deploy --minify
          
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
