name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Deploy Backend
        run: |
          set -ex  # æ˜¾ç¤ºæ‰€æœ‰æ‰§è¡Œçš„å‘½ä»¤
          
          echo "=== å¼€å§‹éƒ¨ç½²æµç¨‹ ==="
          
          # 0. æ˜¾ç¤ºå½“å‰ç›®å½•ç»“æ„
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•ç»“æ„:"
          ls -la
          echo ""
          echo "worker ç›®å½•:"
          ls -la worker/
          echo ""
          echo "æŸ¥æ‰¾ TypeScript æ–‡ä»¶:"
          find worker/ -name "*.ts" -type f | head -10
          
          # 1. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
          USE_WORKER_ASSETS="${{ secrets.USE_WORKER_ASSETS }}"
          USE_WORKER_ASSETS_WITH_TELEGRAM="${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}"
          
          if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ]; then
            echo "=== æ„å»ºå‰ç«¯ ==="
            cd frontend/
            pnpm install --no-frozen-lockfile
            
            if [ -n "$USE_WORKER_ASSETS_WITH_TELEGRAM" ] && [ "$USE_WORKER_ASSETS_WITH_TELEGRAM" != "false" ]; then
              pnpm build:telegram:pages
            else
              pnpm build:pages
            fi
            
            # éªŒè¯æ„å»º
            echo "å‰ç«¯æ„å»ºç»“æœ:"
            ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
            cd ..
          fi
          
          # 2. è¿›å…¥ worker ç›®å½•
          echo "=== è¿›å…¥ worker ç›®å½• ==="
          cd worker/
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          # 3. åˆ›å»ºæ­£ç¡®çš„ wrangler.toml
          echo "=== åˆ›å»º wrangler.toml ==="
          
          # ç¡®å®šå…¥å£æ–‡ä»¶
          if [ -f "src/worker.ts" ]; then
            MAIN_FILE="src/worker.ts"
          elif [ -f "src/index.ts" ]; then
            MAIN_FILE="src/index.ts"
          elif [ -f "index.ts" ]; then
            MAIN_FILE="index.ts"
          else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å…¥å£æ–‡ä»¶"
            find . -name "*.ts" -type f
            exit 1
          fi
          
          echo "ä½¿ç”¨å…¥å£æ–‡ä»¶: $MAIN_FILE"
          
          # åˆ›å»º wrangler.toml
          cat > wrangler.toml << EOF
name = "temp-email-worker"
compatibility_date = "$(date +%Y-%m-%d)"
main = "$MAIN_FILE"
EOF
          
          # å¦‚æœéœ€è¦ assetsï¼Œæ·»åŠ é…ç½®
          if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ] && [ -d "../frontend/dist" ]; then
            cat >> wrangler.toml << EOF

[assets]
directory = "../frontend/dist"
binding = "ASSETS"
EOF
            echo "æ·»åŠ äº† assets é…ç½®"
          fi
          
          # æ˜¾ç¤ºé…ç½®æ–‡ä»¶
          echo "ç”Ÿæˆçš„ wrangler.toml:"
          echo "========================================"
          cat wrangler.toml
          echo "========================================"
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "éªŒè¯æ–‡ä»¶:"
          echo "å…¥å£æ–‡ä»¶: $MAIN_FILE - $( [ -f "$MAIN_FILE" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨" )"
          if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ]; then
            echo "Assets ç›®å½•: ../frontend/dist - $( [ -d "../frontend/dist" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨" )"
          fi
          
          # 4. å®‰è£…ä¾èµ–
          echo "=== å®‰è£…ä¾èµ– ==="
          pnpm install --no-frozen-lockfile
          
          # 5. å®‰è£…é‚®ä»¶è§£æå™¨ï¼ˆå¯é€‰ï¼‰
          USE_MAIL_WASM_PARSER="${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}"
          if [ -n "$USE_MAIL_WASM_PARSER" ] && [ "$USE_MAIL_WASM_PARSER" != "false" ]; then
            echo "å®‰è£… mail-parser-wasm-worker..."
            pnpm add mail-parser-wasm-worker || echo "å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
          fi
          
          # 6. éªŒè¯ wrangler é…ç½®
          echo "=== éªŒè¯é…ç½® ==="
          npx wrangler --version
          
          echo "æ£€æŸ¥ wrangler é…ç½®:"
          npx wrangler config 2>&1 || true
          
          # 7. æ‰§è¡Œéƒ¨ç½² - ä½¿ç”¨ç›´æ¥å‘½ä»¤ç¡®ä¿é…ç½®è¢«ä½¿ç”¨
          echo "=== æ‰§è¡Œéƒ¨ç½² ==="
          
          # æ–¹æ³•1ï¼šä½¿ç”¨ wrangler.toml
          echo "æ–¹æ³•1ï¼šä½¿ç”¨ wrangler.toml é…ç½®éƒ¨ç½²"
          DEPLOY_OUTPUT=$(npx wrangler deploy --minify 2>&1)
          DEPLOY_EXIT=$?
          
          if [ $DEPLOY_EXIT -eq 0 ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "$DEPLOY_OUTPUT"
          else
            echo "âŒ æ–¹æ³•1å¤±è´¥ï¼Œé€€å‡ºç : $DEPLOY_EXIT"
            echo "è¾“å‡º:"
            echo "$DEPLOY_OUTPUT"
            
            # æ–¹æ³•2ï¼šç›´æ¥æŒ‡å®šå‚æ•°
            echo ""
            echo "æ–¹æ³•2ï¼šç›´æ¥æŒ‡å®šå‚æ•°éƒ¨ç½²"
            if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ] && [ -d "../frontend/dist" ]; then
              npx wrangler deploy "$MAIN_FILE" \
                --name "temp-email-worker" \
                --compatibility-date "$(date +%Y-%m-%d)" \
                --assets "../frontend/dist" \
                --assets-binding "ASSETS" \
                --minify
            else
              npx wrangler deploy "$MAIN_FILE" \
                --name "temp-email-worker" \
                --compatibility-date "$(date +%Y-%m-%d)" \
                --minify
            fi
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
