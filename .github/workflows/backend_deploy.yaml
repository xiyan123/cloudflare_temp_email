name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: Debug environment
        run: |
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "æ ‡ç­¾: ${{ github.ref_name }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "äº‹ä»¶: ${{ github.event_name }}"
          echo "Node: $(node --version)"
          echo "pnpm: $(pnpm --version)"
          echo "npm: $(npm --version)"
          
          echo "é¡¹ç›®ç»“æ„:"
          ls -la
          echo ""
          echo "frontend ç›®å½•:"
          ls -la frontend/ 2>/dev/null || echo "frontend ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "worker ç›®å½•:"
          ls -la worker/ 2>/dev/null || echo "worker ç›®å½•ä¸å­˜åœ¨"

      - name: Build and Deploy
        run: |
          set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥åˆ™é€€å‡º
          
          echo "=== å¼€å§‹æ„å»ºå’Œéƒ¨ç½²æµç¨‹ ==="
          
          # è¯»å–ç¯å¢ƒå˜é‡
          USE_WORKER_ASSETS="${{ secrets.USE_WORKER_ASSETS }}"
          USE_WORKER_ASSETS_WITH_TELEGRAM="${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}"
          DEBUG_MODE="${{ secrets.DEBUG_MODE }}"
          USE_MAIL_WASM_PARSER="${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}"
          
          echo "é…ç½®å‚æ•°:"
          echo "USE_WORKER_ASSETS: ${USE_WORKER_ASSETS:-æœªè®¾ç½®}"
          echo "USE_WORKER_ASSETS_WITH_TELEGRAM: ${USE_WORKER_ASSETS_WITH_TELEGRAM:-æœªè®¾ç½®}"
          echo "DEBUG_MODE: ${DEBUG_MODE:-æœªè®¾ç½®}"
          echo "USE_MAIL_WASM_PARSER: ${USE_MAIL_WASM_PARSER:-æœªè®¾ç½®}"
          
          # ========== 1. æ„å»ºå‰ç«¯èµ„æº ==========
          echo ""
          echo "=== æ­¥éª¤1: æ„å»ºå‰ç«¯èµ„æº ==="
          
          if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ]; then
            echo "å‰ç«¯æ„å»ºå·²å¯ç”¨"
            
            if [ ! -d "frontend" ]; then
              echo "âŒ é”™è¯¯: frontend ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            cd frontend/
            
            echo "å®‰è£…å‰ç«¯ä¾èµ–..."
            pnpm install --no-frozen-lockfile
            
            echo "æ‰§è¡Œå‰ç«¯æ„å»º..."
            if [ -n "$USE_WORKER_ASSETS_WITH_TELEGRAM" ] && [ "$USE_WORKER_ASSETS_WITH_TELEGRAM" != "false" ]; then
              echo "æ„å»º Telegram ç‰ˆæœ¬é¡µé¢"
              pnpm build:telegram:pages
            else
              echo "æ„å»ºæ ‡å‡†é¡µé¢"
              pnpm build:pages
            fi
            
            # éªŒè¯æ„å»ºç»“æœ
            if [ ! -d "dist" ]; then
              echo "âŒ é”™è¯¯: å‰ç«¯æ„å»ºå¤±è´¥ï¼Œdist ç›®å½•ä¸å­˜åœ¨"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la
              exit 1
            fi
            
            echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
            echo "dist ç›®å½•å†…å®¹:"
            ls -la dist/
            
            cd ..
          else
            echo "è·³è¿‡å‰ç«¯æ„å»º"
          fi
          
          # ========== 2. å‡†å¤‡åç«¯éƒ¨ç½² ==========
          echo ""
          echo "=== æ­¥éª¤2: å‡†å¤‡åç«¯éƒ¨ç½² ==="
          
          if [ ! -d "worker" ]; then
            echo "âŒ é”™è¯¯: worker ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          cd worker/
          
          # éªŒè¯ worker å…¥å£æ–‡ä»¶
          echo "æ£€æŸ¥ worker å…¥å£æ–‡ä»¶..."
          if [ -f "src/worker.ts" ]; then
            echo "âœ… æ‰¾åˆ° worker å…¥å£: src/worker.ts"
            ENTRY_POINT="src/worker.ts"
          elif [ -f "src/index.ts" ]; then
            echo "âœ… æ‰¾åˆ° worker å…¥å£: src/index.ts"
            ENTRY_POINT="src/index.ts"
          elif [ -f "index.ts" ]; then
            echo "âœ… æ‰¾åˆ° worker å…¥å£: index.ts"
            ENTRY_POINT="index.ts"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° worker å…¥å£æ–‡ä»¶"
            echo "å¯ç”¨æ–‡ä»¶:"
            find . -name "*.ts" -o -name "*.js" | head -20
            exit 1
          fi
          
          # ========== 3. åˆ›å»º wrangler.toml é…ç½® ==========
          echo ""
          echo "=== æ­¥éª¤3: åˆ›å»º wrangler.toml é…ç½® ==="
          
          # ä½¿ç”¨æ¨¡æ¿åˆ›å»ºæœ€å°åŒ–é…ç½®
          cat > wrangler.toml << 'EOL'
name = "temp-email-worker"
compatibility_date = "$(date +%Y-%m-%d)"
EOL
          
          # æ·»åŠ ä¸»å…¥å£
          echo "main = \"$ENTRY_POINT\"" >> wrangler.toml
          
          # å¦‚æœæœ‰å‰ç«¯èµ„æºï¼Œæ·»åŠ  assets é…ç½®
          if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ]; then
            if [ -d "../frontend/dist" ]; then
              echo "" >> wrangler.toml
              echo "[assets]" >> wrangler.toml
              echo 'directory = "../frontend/dist"' >> wrangler.toml
              echo 'binding = "ASSETS"' >> wrangler.toml
              echo "âœ… æ·»åŠ  assets é…ç½®"
            else
              echo "âš ï¸  è­¦å‘Š: å‰ç«¯æ„å»ºå·²å¯ç”¨ï¼Œä½† ../frontend/dist ä¸å­˜åœ¨"
            fi
          fi
          
          # æ·»åŠ å…¶ä»–å¿…è¦é…ç½®ï¼ˆæ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´ï¼‰
          echo "" >> wrangler.toml
          echo "[vars]" >> wrangler.toml
          echo 'DOMAINS = ["tep-mail.org"]' >> wrangler.toml
          echo 'JWT_SECRET = "${{ secrets.JWT_SECRET }}"' >> wrangler.toml
          
          # æ˜¾ç¤ºé…ç½®
          echo "ç”Ÿæˆçš„ wrangler.toml é…ç½®:"
          echo "========================================"
          cat wrangler.toml
          echo "========================================"
          
          # ========== 4. å®‰è£…åç«¯ä¾èµ– ==========
          echo ""
          echo "=== æ­¥éª¤4: å®‰è£…åç«¯ä¾èµ– ==="
          
          echo "å®‰è£… pnpm ä¾èµ–..."
          pnpm install --no-frozen-lockfile
          
          # æ£€æŸ¥ wrangler æ˜¯å¦å®‰è£…
          if [ ! -f "node_modules/.bin/wrangler" ]; then
            echo "wrangler æœªæ‰¾åˆ°ï¼Œå°è¯•å®‰è£…..."
            pnpm add -D wrangler
          fi
          
          # ========== 5. å¯é€‰çš„é‚®ä»¶è§£æå™¨ ==========
          echo ""
          echo "=== æ­¥éª¤5: å¯é€‰ç»„ä»¶å®‰è£… ==="
          
          if [ -n "$USE_MAIL_WASM_PARSER" ] && [ "$USE_MAIL_WASM_PARSER" != "false" ]; then
            echo "å®‰è£… mail-parser-wasm-worker..."
            pnpm add mail-parser-wasm-worker
            
            # åº”ç”¨è¡¥ä¸ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            PATCH_FILE="../.github/config/mail-parser-wasm-worker.patch"
            if [ -f "$PATCH_FILE" ]; then
              echo "åº”ç”¨è¡¥ä¸æ–‡ä»¶..."
              if command -v patch >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y patch); then
                patch -p1 < "$PATCH_FILE" 2>/dev/null && echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ" || echo "âš ï¸  è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œç»§ç»­..."
              else
                echo "âš ï¸  patch å‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡è¡¥ä¸"
              fi
            else
              echo "âš ï¸  è¡¥ä¸æ–‡ä»¶ä¸å­˜åœ¨: $PATCH_FILE"
            fi
          else
            echo "è·³è¿‡é‚®ä»¶è§£æå™¨å®‰è£…"
          fi
          
          # ========== 6. éªŒè¯é…ç½® ==========
          echo ""
          echo "=== æ­¥éª¤6: éªŒè¯é…ç½® ==="
          
          echo "æ£€æŸ¥æ–‡ä»¶è·¯å¾„:"
          echo "Worker å…¥å£: $(pwd)/$ENTRY_POINT"
          [ -f "$ENTRY_POINT" ] && echo "âœ… å…¥å£æ–‡ä»¶å­˜åœ¨" || echo "âŒ å…¥å£æ–‡ä»¶ä¸å­˜åœ¨"
          
          if [ -n "$USE_WORKER_ASSETS" ] && [ "$USE_WORKER_ASSETS" != "false" ]; then
            echo "Assets ç›®å½•: $(pwd)/../frontend/dist"
            [ -d "../frontend/dist" ] && echo "âœ… assets ç›®å½•å­˜åœ¨" || echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "æ£€æŸ¥ wrangler ç‰ˆæœ¬:"
          npx wrangler --version
          
          # ========== 7. æ‰§è¡Œéƒ¨ç½² ==========
          echo ""
          echo "=== æ­¥éª¤7: æ‰§è¡Œéƒ¨ç½² ==="
          
          echo "å¼€å§‹éƒ¨ç½²åˆ° Cloudflare Workers..."
          
          # è®¾ç½®éƒ¨ç½²å‘½ä»¤
          DEPLOY_CMD="npx wrangler deploy"
          
          # æ ¹æ®è°ƒè¯•æ¨¡å¼è°ƒæ•´
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "ğŸ”§ è°ƒè¯•æ¨¡å¼å¯ç”¨"
            DEPLOY_CMD="$DEPLOY_CMD --verbose"
          else
            DEPLOY_CMD="$DEPLOY_CMD --minify"
          fi
          
          # æ‰§è¡Œéƒ¨ç½²
          echo "æ‰§è¡Œå‘½ä»¤: $DEPLOY_CMD"
          
          # è®¾ç½®é‡è¯•æœºåˆ¶
          MAX_RETRIES=3
          RETRY_COUNT=0
          DEPLOY_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$DEPLOY_SUCCESS" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo ""
            echo "éƒ¨ç½²å°è¯• #$RETRY_CONT"
            
            if eval $DEPLOY_CMD; then
              DEPLOY_SUCCESS=true
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            else
              DEPLOY_EXIT_CODE=$?
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œé€€å‡ºç : $DEPLOY_EXIT_CODE"
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
                
                # å°è¯•ä¸åŒçš„éƒ¨ç½²æ–¹å¼
                echo "å°è¯•å¤‡ç”¨éƒ¨ç½²æ–¹æ¡ˆ..."
                if [ $RETRY_COUNT -eq 2 ]; then
                  echo "å°è¯•ç›´æ¥æŒ‡å®šå…¥å£ç‚¹éƒ¨ç½²..."
                  npx wrangler deploy "$ENTRY_POINT" --minify && DEPLOY_SUCCESS=true || continue
                fi
              fi
            fi
          done
          
          # æ£€æŸ¥æœ€ç»ˆç»“æœ
          if [ "$DEPLOY_SUCCESS" = true ]; then
            echo ""
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "Worker åç§°: temp-email-worker"
            echo "éƒ¨ç½²æ ‡ç­¾: ${{ github.ref_name }}"
            echo "æ—¶é—´: $(date)"
          else
            echo ""
            echo "ğŸ’¥ éƒ¨ç½²å¤±è´¥ï¼Œå·²å°è¯• $MAX_RETRIES æ¬¡"
            echo "è¯·æ£€æŸ¥:"
            echo "1. Cloudflare è´¦æˆ·å’Œ Token æ˜¯å¦æ­£ç¡®"
            echo "2. wrangler.toml é…ç½®æ˜¯å¦æ­£ç¡®"
            echo "3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
            echo "4. é¡¹ç›®æ–‡ä»¶ç»“æ„æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          
          # ========== 8. æ¸…ç† ==========
          echo ""
          echo "=== æ­¥éª¤8: æ¸…ç† ==="
          
          # ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
          rm -f wrangler.toml 2>/dev/null || true
          
          echo "âœ… æ‰€æœ‰æ­¥éª¤å®Œæˆ"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: |
            worker/wrangler.toml
            **/*.log
          retention-days: 7

      - name: Success notification
        if: success()
        run: |
          echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æ ‡ç­¾: ${{ github.ref_name }}"
          echo "æ—¶é—´: $(date)"
