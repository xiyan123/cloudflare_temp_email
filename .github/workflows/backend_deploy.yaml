name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Build frontend if needed
        run: |
          if [ "${{ secrets.USE_WORKER_ASSETS }}" = "true" ]; then
            cd frontend/
            pnpm install --no-frozen-lockfile
            if [ "${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}" = "true" ]; then
              pnpm build:telegram:pages
            else
              pnpm build:pages
            fi
            cd ..
          fi

      - name: Deploy Worker
        run: |
          cd worker/
          
          # 创建基本的 wrangler.toml
          echo 'name = "temp-email-worker"' > wrangler.toml
          echo 'compatibility_date = "2025-12-08"' >> wrangler.toml
          echo 'main = "src/worker.ts"' >> wrangler.toml
          
          # 如果需要添加 assets 配置
          if [ "${{ secrets.USE_WORKER_ASSETS }}" = "true" ]; then
            echo '' >> wrangler.toml
            echo '[assets]' >> wrangler.toml
            echo 'directory = "../frontend/dist"' >> wrangler.toml
            echo 'binding = "ASSETS"' >> wrangler.toml
          fi
          
          # 显示配置文件
          echo "=== wrangler.toml 内容 ==="
          cat wrangler.toml
          echo "========================"
          
          # 安装依赖
          pnpm install --no-frozen-lockfile
          
          # 可选安装邮件解析器
          if [ "${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}" = "true" ]; then
            pnpm add mail-parser-wasm-worker
          fi
          
          # 部署
          npx wrangler deploy --minify
          
          echo "✅ 部署成功完成！"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
